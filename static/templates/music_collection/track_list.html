<!-- http://stackoverflow.com/a/5759160/2610955 is used in the number of stars construction -->

<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Hello World in Backbone.js</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-tagsinput/1.3.6/jquery.tagsinput.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-star-rating/4.0.1/css/star-rating.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-star-rating/4.0.1/css/theme-krajee-fa.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rateYo/2.1.1/jquery.rateyo.min.css">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-tagsinput/1.3.6/jquery.tagsinput.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js" type="text/javascript"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js" type="text/javascript"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-star-rating/4.0.1/js/star-rating.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/rateYo/2.1.1/jquery.rateyo.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.paginator/0.8/backbone.paginator.min.js"></script>
        <style>
         .editing {
             outline: 1px solid black;
         }
        </style>
        
    </head>

    <body>

        <div id="my-container" class="container container-fluid" style="width:600px">
        </div>

        <script type="text/template" id="pagination-template">
            <button class="btn btn-primary" href="<%= previous %>" id="prev-page">
                Previous
            </button>
            <button class="btn btn-primary" href="<%= next %>" id="next-page">
                Next
            </button>
        </script>
        
        <script type="text/template" id="item-template">
            <div class="row" style="margin-top:5px;">
                <div class="panel panel-success">
                    <div class="panel-heading <%= save ? 'editing' : '' %>" style="height:40px" <% if (save) { %> contenteditable='true' <% } %> >
                        <%= title %>
                    </div>
                    <div class="panel-body post-content">
                        <div class="col-xs-6">
                            <input name="tags" class="tags" value= "<%= _.map(genre, function(item) { return item.title; }) %>" >
                        </div>
                        <div class="col-xs-5">
                            <div class="rating" name="input-<%= id %>"> </div>
                        </div>
                        <div class="col-xs-1">
                            <div class="pull-right">
                                <button class="btn btn-primary btn-sm todo-edit" style="vertical-align:middle"> <%= save ? "Save" : "Edit" %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </script>

        <script>
         var Todo = Backbone.Model.extend({
             defaults: {"title" : "sample title" , "genre" : ["pop"], "rating": 4, id: 0},
             urlRoot: "/api/tracks/",
         });

         var TodoItemView = Backbone.View.extend({

             initialize: function() {
                 this.save = false;
                 this.readOnly = !this.save;
             },
             
             events: {
                 'click .todo-edit': 'toggleEdit',
             },

             toggleEdit: function(e) {
                 this.readOnly = this.save;
                 this.save = !this.save;
                 if (!this.save) {
                     this.model.set("title", $('.panel-heading', this.$el).text());
                     this.model.set("rating", $('.rating', this.$el).rateYo("rating"));
                     this.model.save();
                 }
                 this.render();
             },

             todo_tpl: _.template($('#item-template').html()),

             render: function() {
                 var context = $.extend({}, this.model.toJSON(), {save: this.save, id: this.model.get("id") });
                 this.$el.html(this.todo_tpl(context));
                 var readOnly = this.readOnly;
                 var rating = this.model.get("rating");
                 var id = this.model.get("id");
                 $('.rating', this.$el).rateYo({ rating: rating });
                 $('.rating', this.$el).rateYo("option", "readOnly", readOnly);
                 return this;
             },
         });

         var TodoCollection = Backbone.Collection.extend({
             model: Todo,

             page: 1,

             count: 10,

             previous: null,
             
             next: null,
             
             url: "/api/tracks/",

             parse: function(data) {
                 this.count = data.count;
                 this.next = data.next;
                 this.previous = data.previous;
                 return data.results
             },
         });

         var todoCollection = new TodoCollection();

         var PaginatorView = Backbone.View.extend({
             paginator_tpl: _.template($('#pagination-template').html()),

             events: {
                 'click #prev-page': 'previous_page',
                 'click #next-page': 'next_page',
             },

             next_page: function(e) {
                 var next = this.options.next.substr(-1, 1);
                 todoCollection.fetch({ async:false, data: $.param({page: next}) }).then(function() { todo_list_view.render(); });
             },

             previous_page: function(e) {
                 var previous = this.options.previous ? (this.options.previous.substr(-1, 1) == "/" ? 1 : this.options.previous.substr(-1, 1)) : 1;
                 console.log(previous);
                 todoCollection.fetch({ async:false, data: $.param({page: previous}) }).then(function() { todo_list_view.render(); });
             },
             
             render: function() {
                 var page_results = { next: this.options.next, previous: this.options.previous };
                 this.$el.html(this.paginator_tpl(page_results));
                 return this;
             }
         })
         
         var TodoListView = Backbone.View.extend({
             
             el: '#my-container',
             
             render: function() {

                 this.$el.empty();
                 
                 this.collection.each(function(item) {
                     var todo1_view = new TodoItemView({model: item});
                     this.$el.append(todo1_view.render().el);
                 }, this);

                 var paginatorView = new PaginatorView({next: this.collection.next, previous: this.collection.previous});
                 
                 this.$el.append(paginatorView.render().el);
                 
                 $('.tags').tagsInput({height: '60px', width: '250px'});
                 return this;
             },

         });

         var todo_list_view = new TodoListView({collection: todoCollection });
         todoCollection.fetch({ async:false, data: $.param({page: 1}) }).then(function() { todo_list_view.render(); });
        </script>
    </body>
</html>
